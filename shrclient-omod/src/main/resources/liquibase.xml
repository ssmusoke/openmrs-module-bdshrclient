<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">


    <changeSet id="shrclient-020514" author="tw" context="setup">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*) from scheduler_task_config where
                schedulable_class='org.openmrs.module.shrclient.scheduler.tasks.BahmniSyncTask';
            </sqlCheck>
        </preConditions>

        <insert tableName="scheduler_task_config">
            <column name="name" value="Bahmni sync task"/>
            <column name="schedulable_class" value="org.openmrs.module.shrclient.scheduler.tasks.BahmniSyncTask"/>
            <column name="start_time" valueDate=" now() "/>
            <column name="start_time_pattern" value="MM/dd/yyyy HH:mm:ss"/>
            <column name="repeat_interval" value="60"/>
            <column name="start_on_startup" value="1"/>
            <column name="started" value="1"/>
            <column name="created_by" value="1"/>
            <column name="date_created" valueDate=" now() "/>
            <column name="uuid" valueComputed=" uuid() "/>
        </insert>

    </changeSet>

    <changeSet id="shrclient-040614" author="tw" context="setup">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*) from users where system_id = 'shrclientsystem';
            </sqlCheck>
        </preConditions>
        <sql>
            set @puuid = uuid();

            insert into person(birthdate_estimated, dead, creator, date_created, uuid)
            values(0, 0, 1, now(), @puuid);

            insert into users(system_id, creator, date_created, person_id, uuid, username)
            values ('shrclientsystem', 1, now(),(select person_id from person where uuid = @puuid) , uuid(), 'shrclientsystem');

            insert into provider (person_id, identifier, creator, date_created, uuid, name) values ((select person_id from person where uuid = @puuid), 'SHRCLIENTSYSTEM', 1, now(), uuid(), 'shrclientsystem');
        </sql>
    </changeSet>

    <changeSet id="bdshrclient-100714" author="tw" context="setup">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">
                select count(*) from chunking_history;
            </sqlCheck>
        </preConditions>
        <sql>
            truncate chunking_history;
            insert into chunking_history (chunk_length, start) values (100, 1);
        </sql>
    </changeSet>

    <changeSet id="bdshrclient-110714" author="tw" context="setup">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*) from concept_name where name = "uncategorized diagnoses";
            </sqlCheck>
        </preConditions>
        <sql>
            set @concept_id = 0;
            set @concept_name_short_id = 0;
            set @concept_name_full_id = 0;
            call add_concept(@concept_id, @concept_name_short_id, @concept_name_full_id, 'uncategorized diagnoses', 'uncategorized diagnoses', 'N/A', 'ConvSet', true);
            call add_concept_word(@concept_id, @concept_name_short_id, 'uncategorized', 1);
            call add_concept_word(@concept_id, @concept_name_short_id, 'diagnoses', 1);
        </sql>
    </changeSet>

    <changeSet id="bdshrclient-110714-1" author="tw" context="setup">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*) from person_name where given_name = "shrclientsystem";
            </sqlCheck>
        </preConditions>
        <sql>
            set @person_id = 0;
            select person_id into @person_id from users where username = 'shrclientsystem';
            insert into person_name (preferred, person_id, given_name, family_name, creator, date_created) values (1, @person_id, 'shrclientsystem', 'system', 1, now());
        </sql>
    </changeSet>

    <changeSet id="bdshrclient-1" author="tw" context="setup">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*) from scheduler_task_config where
                schedulable_class='org.openmrs.module.shrclient.scheduler.tasks.BahmniSyncRetryTask';
            </sqlCheck>
        </preConditions>

        <insert tableName="scheduler_task_config">
            <column name="name" value="Bahmni sync retry task"/>
            <column name="schedulable_class" value="org.openmrs.module.shrclient.scheduler.tasks.BahmniSyncRetryTask"/>
            <column name="start_time" valueDate=" now() "/>
            <column name="start_time_pattern" value="MM/dd/yyyy HH:mm:ss"/>
            <column name="repeat_interval" value="120"/>
            <column name="start_on_startup" value="1"/>
            <column name="started" value="1"/>
            <column name="created_by" value="1"/>
            <column name="date_created" valueDate=" now() "/>
            <column name="uuid" valueComputed=" uuid() "/>
        </insert>

    </changeSet>

    <changeSet id="bdshrclient-291014-2100" author="tw" context="setup">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*) from scheduler_task_config where
                schedulable_class='org.openmrs.module.shrclient.scheduler.tasks.CatchmentEncounterDownloadTask';
            </sqlCheck>
        </preConditions>

        <insert tableName="scheduler_task_config">
            <column name="name" value="Catchment Encounters Sync Task"/>
            <column name="schedulable_class" value="org.openmrs.module.shrclient.scheduler.tasks.CatchmentEncounterDownloadTask"/>
            <column name="start_time" valueDate=" now() "/>
            <column name="start_time_pattern" value="MM/dd/yyyy HH:mm:ss"/>
            <column name="repeat_interval" value="60"/>
            <column name="start_on_startup" value="1"/>
            <column name="started" value="1"/>
            <column name="created_by" value="1"/>
            <column name="date_created" valueDate=" now() "/>
            <column name="uuid" valueComputed=" uuid() "/>
        </insert>

    </changeSet>

    <changeSet id="bdshrclient-311014-2000" author="tw" context="setup">
        <comment>
            Changing the failed_events.event_content type to text from default varchar(4000), since content can get larger than that.
            This change is scheduled for ICT4H AtomFeed 1.3.
        </comment>
        <modifyDataType columnName="event_content"
                        newDataType="TEXT"
                        tableName="failed_events"/>

    </changeSet>

    <changeSet id="bdshrclient-041114-2100" author="tw" context="setup">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*) from scheduler_task_config where
                schedulable_class='org.openmrs.module.shrclient.scheduler.tasks.LRSyncTask';
            </sqlCheck>
        </preConditions>

        <insert tableName="scheduler_task_config">
            <column name="name" value="LR Sync Task"/>
            <column name="schedulable_class" value="org.openmrs.module.shrclient.scheduler.tasks.LRSyncTask"/>
            <column name="start_time" valueDate=" now() "/>
            <column name="start_time_pattern" value="MM/dd/yyyy HH:mm:ss"/>
            <column name="repeat_interval" value="15"/>
            <column name="start_on_startup" value="1"/>
            <column name="started" value="1"/>
            <column name="created_by" value="1"/>
            <column name="date_created" valueDate=" now() "/>
            <column name="uuid" valueComputed=" uuid() "/>
        </insert>

    </changeSet>

    <changeSet id="bdshrclient-111114-1700" author="tw" context="setup">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*) from scheduler_task_config where
                schedulable_class='org.openmrs.module.shrclient.scheduler.tasks.FRSyncTask';
            </sqlCheck>
        </preConditions>

        <insert tableName="scheduler_task_config">
            <column name="name" value="FR Sync Task"/>
            <column name="schedulable_class" value="org.openmrs.module.shrclient.scheduler.tasks.FRSyncTask"/>
            <column name="start_time" valueDate=" now() "/>
            <column name="start_time_pattern" value="MM/dd/yyyy HH:mm:ss"/>
            <column name="repeat_interval" value="15"/>
            <column name="start_on_startup" value="1"/>
            <column name="started" value="1"/>
            <column name="created_by" value="1"/>
            <column name="date_created" valueDate=" now() "/>
            <column name="uuid" valueComputed=" uuid() "/>
        </insert>

    </changeSet>

    <changeSet id="bdshrclient-131114-1800" author="tw" context="setup">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*) from location_tag where
                name='SharedHealth Locations';
            </sqlCheck>
        </preConditions>

        <insert tableName="location_tag">
            <column name="name" value="SharedHealth Locations"/>
            <column name="creator" value="1"/>
            <column name="date_created" valueDate=" now() "/>
            <column name="uuid" valueComputed=" uuid() " />
        </insert>

    </changeSet>


    <changeSet id="bdshrclient-191114-1800" author="tw" context="setup">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*) from markers where
                last_read_entry_id='LR Sync Task';
            </sqlCheck>
        </preConditions>

        <insert tableName="markers">
            <column name="feed_uri" value="lr.divisions"/>
            <column name="last_read_entry_id" value="LR Sync Task"/>
        </insert>

        <insert tableName="markers">
            <column name="feed_uri" value="lr.districts"/>
            <column name="last_read_entry_id" value="LR Sync Task"/>
        </insert>

        <insert tableName="markers">
            <column name="feed_uri" value="lr.upazilas"/>
            <column name="last_read_entry_id" value="LR Sync Task"/>
        </insert>

        <insert tableName="markers">
            <column name="feed_uri" value="lr.paurasavas"/>
            <column name="last_read_entry_id" value="LR Sync Task"/>
        </insert>

        <insert tableName="markers">
            <column name="feed_uri" value="lr.unions"/>
            <column name="last_read_entry_id" value="LR Sync Task"/>
        </insert>

        <insert tableName="markers">
            <column name="feed_uri" value="lr.wards"/>
            <column name="last_read_entry_id" value="LR Sync Task"/>
        </insert>

    </changeSet>

    <changeSet id="bdshrclient-201114-1600" author="tw" context="setup">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*) from markers where
                last_read_entry_id='FR Sync Task';
            </sqlCheck>
        </preConditions>

        <insert tableName="markers">
            <column name="feed_uri" value="fr.facilities"/>
            <column name="last_read_entry_id" value="FR Sync Task"/>
        </insert>

    </changeSet>

    <changeSet id="bdshrclient-211114-1800" author="tw">
        <update tableName="scheduler_task_config">
            <column name="start_on_startup" value="0" />
            <where>name IN ('LR Sync Task', 'FR Sync Task')</where>
        </update>
    </changeSet>

    <changeSet id="bdshrclient-211114-1810" author="tw">
        <update tableName="scheduler_task_config">
            <column name="started" value="0" />
            <where>name IN ('LR Sync Task', 'FR Sync Task')</where>
        </update>
    </changeSet>

    <changeSet id="bdshrclient-241114-1200" author="tw">
        <update tableName="scheduler_task_config">
            <column name="repeat_interval" value="86400" />
            <where>name IN ('LR Sync Task', 'FR Sync Task')</where>
        </update>
    </changeSet>


    <changeSet id="bdshrclient-241114-1800" author="tw" context="setup">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">
                select count(*) from location_tag where
                name='SharedHealth Locations';
            </sqlCheck>
        </preConditions>

        <update tableName="location_tag">
            <column name="name" value="DGHS Facilities" />
            <where>name = 'SharedHealth Locations'</where>
        </update>

    </changeSet>
    
    <changeSet id="bdshrclient-221214-1500" author="tw" context="setup">
        <modifyDataType tableName="address_hierarchy_entry" columnName="user_generated_id" newDataType="varchar(12)" />
    </changeSet>

    <changeSet id="bdshrclient-221214-1800" author="tw" context="setup">
        <update tableName="markers">
            <column name="last_read_entry_id" value="0" />
            <column name="feed_uri_for_last_read_entry" value="0000-00-00 00:00:00" />
            <where>feed_uri IN ('fr.facilities', 'lr.divisions', 'lr.districts', 'lr.upazilas', 'lr.paurasavas', 'lr.unions', 'lr.wards')</where>
        </update>
    </changeSet>

    <changeSet id="bdshrclient-291214-1800" author="tw" context="setup">
        <delete tableName="markers">
            <where>feed_uri IN ('fr.facilities', 'lr.divisions', 'lr.districts', 'lr.upazilas', 'lr.paurasavas', 'lr.unions', 'lr.wards')</where>
        </delete>
    </changeSet>
    
    <changeSet id="bdshrclient-291214-1805" author="tw">

        <insert tableName="markers">
            <column name="feed_uri" value="urn://lr/divisions"/>
        </insert>

        <insert tableName="markers">
            <column name="feed_uri" value="urn://lr/districts"/>
        </insert>

        <insert tableName="markers">
            <column name="feed_uri" value="urn://lr/upazilas"/>
        </insert>

        <insert tableName="markers">
            <column name="feed_uri" value="urn://lr/paurasavas"/>
        </insert>

        <insert tableName="markers">
            <column name="feed_uri" value="urn://lr/unions"/>
        </insert>

        <insert tableName="markers">
            <column name="feed_uri" value="urn://lr/wards"/>
        </insert>

        <insert tableName="markers">
            <column name="feed_uri" value="urn://fr/facilities"/>
        </insert>
    </changeSet>

</databaseChangeLog>
